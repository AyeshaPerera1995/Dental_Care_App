<!DOCTYPE html>
<html lang="en">
	<!--begin::Head-->
	<head><base href="">
		<meta charset="utf-8" />
		<title><%=sub_title%></title>
		<meta name="description" content="Updates and statistics" />
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
		<!-- <link rel="canonical" href="https://keenthemes.com/metronic" /> -->
		<!--begin::Fonts-->
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700" />
		<!--end::Fonts-->
		<!--begin::Page Vendors Styles(used by this page)-->
		<link href="assets/plugins/custom/fullcalendar/fullcalendar.bundle.css" rel="stylesheet" type="text/css" />
		<!--end::Page Vendors Styles-->
		<!--begin::Global Theme Styles(used by all pages)-->
		<link href="assets/plugins/global/plugins.bundle.css" rel="stylesheet" type="text/css" />
		<link href="assets/plugins/custom/prismjs/prismjs.bundle.css" rel="stylesheet" type="text/css" />
		<link href="assets/css/style.bundle.css" rel="stylesheet" type="text/css" />
		<!--end::Global Theme Styles-->
		<!--begin::Layout Themes(used by all pages)-->
		<!--end::Layout Themes-->
		<link rel="shortcut icon" href="assets/media/logos/favicon.ico" />
		<style>
			.aside-secondary-enabled.aside-fixed .wrapper {
    			padding-left: 0;
			}
			.aside-secondary-enabled .aside {
    			width: 0;
			}	
			.pb-8, .py-8 {
              padding-bottom: 0;
            }
			.disabled {
			  pointer-events: none;
			  cursor: default;
			  opacity: 0.6;
			}
		</style>  
		<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>  
			    <script>				
				
					  const socket = io('http://137.116.141.10:5455/');
					  
					  socket.on("connection", (socket) => {
						  console.log(socket.id);
						});
		
					socket.on('NumberListner', function(data) {
						document.getElementById("ongoing_number").innerHTML = data.appointment_number;									
					});
		
					function setred(){
						var rednumber= document.getElementById("redtext").value;
						socket.emit("NextRedNumber", { RedNumbers:rednumber});
					}
				</script> 
	</head>
	<!--end::Head-->
	<!--begin::Body-->
	<body id="kt_body" class="header-mobile-fixed subheader-enabled aside-enabled aside-fixed aside-secondary-enabled page-loading">
		<!--begin::Main-->
		<!-- MOBILE HEADER -->
		<%- include('includes/mobile_header.ejs'); %>

		<div class="d-flex flex-column flex-root">
			<!--begin::Page-->
			<div class="d-flex flex-row flex-column-fluid page">

			<!-- NAV BAR  -->
			<%- include('includes/navbar.ejs'); %>

				<!--begin::Wrapper-->
				<div class="d-flex flex-column flex-row-fluid wrapper" id="kt_wrapper">
					<!--begin::Content-->
					<div class="content d-flex flex-column flex-column-fluid" id="kt_content">
						<!--begin::Subheader-->
						<div class="subheader py-3 py-lg-8 subheader-transparent" id="kt_subheader">
							<div class="container d-flex align-items-center justify-content-between flex-wrap flex-sm-nowrap">

							<!-- HEADER  -->
								<!--begin::Info-->
							<div class="d-flex align-items-center mr-1">
							    <!--begin::Page Heading-->
							    <div class="d-flex align-items-baseline flex-wrap mr-5">
							        <!--begin::Page Title-->
							        <!-- <h2 class="d-flex align-items-center text-dark font-weight-bold my-1 mr-3"><%=sub_title%></h2>&nbsp;&nbsp;&nbsp; -->
							        <!--end::Page Title-->
							        <!--begin::Breadcrumb-->
							<h3 style="color: rgb(170, 170, 170);">Dashboard</h3>
							<!--end::Breadcrumb-->
							    </div>
							    <!--end::Page Heading-->
							</div>
							<!--end::Info-->
							<!--begin::Toolbar-->
							<div class="dropdown dropdown-inline d-flex align-items-center flex-wrap">
							    <p style="color: rgb(161, 160, 160); padding-top: 10px; padding-right: 5px;">Welcome <%=current_user.first_name%></p> 
							    <a href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
							        <span class="svg-icon svg-icon-primary svg-icon-3x"><!--begin::Svg Icon | path:C:\wamp64\www\keenthemes\themes\metronic\theme\html\demo3\dist/../src/media/svg/icons\Communication\Contact1.svg--><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
							            <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
							                <rect x="0" y="0" width="24" height="24"/>
							                <circle fill="#000000" opacity="0.3" cx="12" cy="12" r="10"/>
							                <path d="M12,11 C10.8954305,11 10,10.1045695 10,9 C10,7.8954305 10.8954305,7 12,7 C13.1045695,7 14,7.8954305 14,9 C14,10.1045695 13.1045695,11 12,11 Z M7.00036205,16.4995035 C7.21569918,13.5165724 9.36772908,12 11.9907452,12 C14.6506758,12 16.8360465,13.4332455 16.9988413,16.5 C17.0053266,16.6221713 16.9988413,17 16.5815,17 L7.4041679,17 C7.26484009,17 6.98863236,16.6619875 7.00036205,16.4995035 Z" fill="#000000" opacity="0.3"/>
							            </g>
							        </svg>
							    </span>         
							    </a>
							    <div class="dropdown-menu p-0 m-0 dropdown-menu-md dropdown-menu-right">
							        <!--begin::Navigation-->
							        <ul class="navi navi-hover">
							            <li class="navi-item">
							                <a href="/auth/my_profile" class="navi-link">
							                    <span class="navi-text"> My Profile </span>
							                </a>
							            </li>
							            <li class="navi-item">
							                <a href="/auth/reset_pass" class="navi-link">
							                    <span class="navi-text"> Reset Password </span>
							                </a>
							            </li>
							        </ul>
							        <!--end::Navigation-->
							    </div>
							</div>
							<!--end::Toolbar-->
							<!-- HEADER  -->



							</div>
						</div>
						<!--end::Subheader-->
						<!--begin::Entry-->
						<div class="d-flex flex-column-fluid">
							<!--begin::Container-->
							<div class="container">
								<!--begin::Dashboard-->
								<!--begin::Row-->
								<div class="row">
									<div class="col-xl-4">
										<!--begin::Mixed Widget 4-->
										<div class="card card-custom bg-radial-gradient-danger gutter-b card-stretch">
											<!--begin::Header-->
											<div class="card-header border-0 py-5">
												
											</div>
											<!--end::Header-->
											<!--begin::Body-->
											<div class="card-body d-flex flex-column p-0">
												<a href="#" class="text-center mb-10" style="background-color: antiquewhite;">
													<img src="assets/media/logos/tdc_logo.png" class="max-h-110px" alt="" />
												</a>
												
												<h3 class="font-weight-bolder text-center font-size-h4" style="color: antiquewhite;">Put On Your Best Smile
													<br />Everyday!</h3>
											</div>
											<!--end::Body-->
										</div>
										<!--end::Mixed Widget 4-->
									</div>
									<div class="col-xl-8">
										<!--begin::List Widget 14-->
										<div class="card card-custom gutter-b card-stretch">
											
											<!--begin::Body-->
											<div class="card-body">	
												<div class="row">
													<div class="col-md-4" style="text-align: center; margin-top: 20px;"><button style="background:transparent; border: none;" onclick="prevBtn();"><i style="font-size: 130px;" class="ki ki-arrow-back"></i></button></div>
													<div class="col-md-4" style="text-align: center; font-size: 150px;"><button style="background:transparent; border: none; color: rgb(243, 41, 135);" onclick="clicknumBtn();" id="ongoing_number"></button></div>
													<div class="col-md-4" style="text-align: center;margin-top: 20px;"><button style="background:transparent; border: none;" onclick="nextBtn();"><i style="font-size: 130px;" class="ki ki-arrow-next"></i></button></div>
												</div>
												<div class="row" style="border-top: 3px #bdbdbd dotted;">
													<span class="card-label font-weight-bolder text-dark" style="font-size: 19px;color: #7a7a85 !important;margin-top: 10px;">Set Red Numbers</span>
												</div>
												<div class="row">													
														<span class="card-label font-weight-bolder text-dark" style="font-size: 30px;">R-</span>
														<input type="text" style="width: 300px; font-size: 20px;" maxlength="2" id="redtext"> 
														<button style="background:rgb(243, 41, 135);border: none;color: white;width: 40px;border-radius: 0px 5px 5px 0px;" onclick="setred();">Set</button>			
												</div>
											</div>
											<!--end::Body-->
										</div>
										<!--end::List Widget 14-->
									</div>
								</div>	

								<!--begin::Row-->
								<div class="row">
									<div class="col-lg-12 col-xxl-12">
										<!--begin::Advance Table Widget 9-->
										<div class="card card-custom card-stretch gutter-b">
											<!--begin::Header-->
											<div class="card-header border-0 py-5">
												<h3 class="card-title align-items-start flex-column">
													<span class="card-label font-weight-bolder text-dark">Appointments</span>
													<span class="text-muted mt-3 font-weight-bold font-size-sm" id="c_date"><%=c_date%></span>
												</h3>
												<div class="card-toolbar">
													<a href="/appointments/add_appointment" class="btn btn-danger font-weight-bolder font-size-sm mr-3">
														<span class="svg-icon svg-icon-md">
															<!--begin::Svg Icon | path:assets/media/svg/icons/Communication/Mail-attachment.svg-->
															<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
																<g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
																	<rect x="0" y="0" width="24" height="24"></rect>
																	<path d="M3.5,21 L20.5,21 C21.3284271,21 22,20.3284271 22,19.5 L22,8.5 C22,7.67157288 21.3284271,7 20.5,7 L10,7 L7.43933983,4.43933983 C7.15803526,4.15803526 6.77650439,4 6.37867966,4 L3.5,4 C2.67157288,4 2,4.67157288 2,5.5 L2,19.5 C2,20.3284271 2.67157288,21 3.5,21 Z" fill="#000000" opacity="0.3"></path>
																	<path d="M11,13 L11,11 C11,10.4477153 11.4477153,10 12,10 C12.5522847,10 13,10.4477153 13,11 L13,13 L15,13 C15.5522847,13 16,13.4477153 16,14 C16,14.5522847 15.5522847,15 15,15 L13,15 L13,17 C13,17.5522847 12.5522847,18 12,18 C11.4477153,18 11,17.5522847 11,17 L11,15 L9,15 C8.44771525,15 8,14.5522847 8,14 C8,13.4477153 8.44771525,13 9,13 L11,13 Z" fill="#000000"></path>
																</g>
															</svg>
															<!--end::Svg Icon-->
														</span>New Appointment</a>
												</div>
											</div>
											<!--end::Header-->
											<!--begin::Body-->
											<div class="card-body pt-0 pb-3">
												<div class="tab-content">
													<!--begin::Table-->
													<div class="table-responsive">
														<table class="table table-head-custom table-vertical-center table-head-bg table-borderless">
															<thead>
																<tr class="text-left">
																	<th style="min-width: 250px" class="pl-7">
																		<span class="text-dark-75">Patient</span>
																	</th>
																	<th style="min-width: 120px">Patient Type</th>
																	<th style="min-width: 120px">Appointment Number</th>
																	<th style="min-width: 100px">Appointment Type</th>
																	<th style="min-width: 100px">Contact</th>
																	<th style="min-width: 100px">Payment</th>
																	<th style="min-width: 100px">Action</th>
																</tr>
															</thead>
															<tbody>

																<% for(var i = 0 ; i < applist.length ; i++) { 
	
																	if (applist[i].patient_Gender == 'Male' && applist[i].patient_type == 'Child') {
																		var img = 'assets/media/svg/avatars/001-boy.svg';
																	}else if (applist[i].patient_Gender == 'Female' && applist[i].patient_type == 'Child') {
																		var img = 'assets/media/svg/avatars/018-girl-9.svg';
																	}else if(applist[i].patient_Gender == 'Male' && applist[i].patient_type == 'Adult'){
																		var img = 'assets/media/svg/avatars/034-boy-14.svg';
																	}else if(applist[i].patient_Gender == 'Female' && applist[i].patient_type == 'Adult'){
																		var img = 'assets/media/svg/avatars/039-girl-21.svg';
																	}else{
																		var img = 'assets/media/users/default.jpg';
																	}

																	if(applist[i].patient_age != ''){
																		var age = applist[i].patient_age+' years old';
																	}else{
																		var age = '';
																	}
																%>

																<tr>
																	<td class="pl-0 py-4">
																		<div class="d-flex align-items-center">
																			<div class="symbol symbol-50 symbol-light mr-4">
																				<span class="symbol-label">
																					<img src="<%=img%>" class="h-75 align-self-end" alt="" />
																				</span>
																			</div>
																			<div>
																				<a href="#" class="text-dark-75 font-weight-bolder text-hover-primary mb-1 font-size-lg"><%=applist[i].patient_name%></a>
																				<span class="text-muted font-weight-bold d-block"><%=age%></span>
																			</div>
																		</div>
																	</td>
																	<td>
																		<span class="text-dark-75 font-weight-bold"><%=applist[i].patient_type%></span>
																	</td>
																	<td>
																		<center><a href="/appointments/print_number/<%=applist[i].appointment_number%>&<%=applist[i].patient_name%>&<%=applist[i].date%>" target="_blank"><span class="label label-lg font-weight-bold label-light-danger label-inline font-weight-bolder" style="color: antiquewhite; font-size: 14px; padding: 10px;" title="Print Number"><%=applist[i].appointment_number%></span></a></center>
																	</td>
																	<td>
																		<span class="text-dark-75 font-weight-bold"><%=applist[i].appointment_type%></span>
																	</td>
																	<td>
																		<span class="text-dark-75 font-weight-bolder d-block"><%=applist[i].patient_contact_number%></span>
																	</td>
																	<td>
																		<% if(applist[i].invoice_balance_list.length == 0){ 
																			var disabled = 'disabled';
																		}else{
																			var disabled = '';
																		}
																		%>
																		<a href="/invoices/payment/<%=JSON.stringify(applist[i].invoice_balance_list)%>&<%=applist[i].appointment_number%>&<%=applist[i].patient_name%>&<%=applist[i].patient_type%>&<%=applist[i].patient_contact_number%>&<%=applist[i].patient_id%>" target="_blank" class="btn btn-sm <%=disabled%>" style="background-color: rgb(245, 100, 148); color: white; width: 80px;">Payment</a>
																	</td>
																	<td>
																		<% if(applist[i].status == 'Pending'){ %>
																			<a href="/invoices/add_invoice/<%=applist[i].appointment_number%>&<%=applist[i].patient_name%>&<%=applist[i].patient_type%>&<%=applist[i].patient_contact_number%>&<%=applist[i].id%>&<%=applist[i].patient_id%>" target="_blank" class="btn btn-sm btn-light-success" style="font-weight: bold;">Create Invoice</a>
																			  <% }else if(applist[i].status == 'Completed'){ %>
																				<a href="/invoices/view_single_invoice/<%=applist[i].id%>" target="_blank" class="btn btn-sm btn-light-success" style="font-weight: bold; width: 110px;">View Invoice</a>
																			<% } %>
																	</td>
																</tr>
																<% } %>
															</tbody>
														</table>
													</div>
													<!--end::Table-->
												</div>
											</div>
											<!--end::Body-->
										</div>
										<!--end::Advance Table Widget 9-->
									</div>
								</div>
								<!--end::Row-->
								
								<!--end::Dashboard-->
							</div>
							<!--end::Container-->
						</div>
						<!--end::Entry-->
					</div>
					<!--end::Content-->
					
					<!-- FOOTER  -->
					<%- include('includes/footer.ejs'); %>

				</div>
				<!--end::Wrapper-->
			</div>
			<!--end::Page-->
		</div>
		<!--end::Main-->

		<!--begin::Scrolltop-->
		<div id="kt_scrolltop" class="scrolltop">
			<span class="svg-icon">
				<!--begin::Svg Icon | path:assets/media/svg/icons/Navigation/Up-2.svg-->
				<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">
					<g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
						<polygon points="0 0 24 0 24 24 0 24" />
						<rect fill="#000000" opacity="0.3" x="11" y="10" width="2" height="10" rx="1" />
						<path d="M6.70710678,12.7071068 C6.31658249,13.0976311 5.68341751,13.0976311 5.29289322,12.7071068 C4.90236893,12.3165825 4.90236893,11.6834175 5.29289322,11.2928932 L11.2928932,5.29289322 C11.6714722,4.91431428 12.2810586,4.90106866 12.6757246,5.26284586 L18.6757246,10.7628459 C19.0828436,11.1360383 19.1103465,11.7686056 18.7371541,12.1757246 C18.3639617,12.5828436 17.7313944,12.6103465 17.3242754,12.2371541 L12.0300757,7.38413782 L6.70710678,12.7071068 Z" fill="#000000" fill-rule="nonzero" />
					</g>
				</svg>
				<!--end::Svg Icon-->
			</span>
		</div>
		<!--end::Scrolltop-->
		<script>var KTAppSettings = { "breakpoints": { "sm": 576, "md": 768, "lg": 992, "xl": 1200, "xxl": 1200 }, "colors": { "theme": { "base": { "white": "#ffffff", "primary": "#e61794", "secondary": "#E5EAEE", "success": "#e61794", "info": "#6993FF", "warning": "#FFA800", "danger": "#e61794", "light": "#F3F6F9", "dark": "#212121" }, "light": { "white": "#ffffff", "primary": "#e61794", "secondary": "#ECF0F3", "success": "#C9F7F5", "info": "#E1E9FF", "warning": "#FFF4DE", "danger": "#e61794", "light": "#F3F6F9", "dark": "#D6D6E0" }, "inverse": { "white": "#ffffff", "primary": "#ffffff", "secondary": "#212121", "success": "#ffffff", "info": "#ffffff", "warning": "#ffffff", "danger": "#ffffff", "light": "#464E5F", "dark": "#ffffff" } }, "gray": { "gray-100": "#F3F6F9", "gray-200": "#ECF0F3", "gray-300": "#E5EAEE", "gray-400": "#D6D6E0", "gray-500": "#B5B5C3", "gray-600": "#80808F", "gray-700": "#464E5F", "gray-800": "#1B283F", "gray-900": "#212121" } }, "font-family": "Poppins" };</script>
		
		<!--begin::Global Theme Bundle(used by all pages)-->
		<script src="assets/plugins/global/plugins.bundle.js"></script>
		<script src="assets/plugins/custom/prismjs/prismjs.bundle.js"></script>
		<script src="assets/js/scripts.bundle.js"></script>
		<!--end::Global Theme Bundle-->
		<!--begin::Page Vendors(used by this page)-->
		<script src="assets/plugins/custom/fullcalendar/fullcalendar.bundle.js"></script>
		<!--end::Page Vendors-->
		<!--begin::Page Scripts(used by this page)-->
		<script src="assets/js/pages/widgets.js"></script>
		<!--end::Page Scripts-->

	</body>
	<!--end::Body-->

<script>

window.onload = function() {
	currentnumBtn();

// function changeTimezone(date, ianatz) {
// 	var invdate = new Date(date.toLocaleString('en-US', {
// 	  timeZone: ianatz
// 	}));
// 	var diff = date.getTime() - invdate.getTime();
// 	return new Date(date.getTime() - diff); // needs to substract
// }

// var here = new Date();
// var there = changeTimezone(here, "Asia/Colombo");
// var c_date = moment(there, "DD/MM/YYYY, h:mm:ss a").format("Do MMMM YYYY , h:mm:ss a"); 
// var a_date = moment(there, "DD/MM/YYYY, h:mm:ss a").format("DD-MM-YYYY");
// console.log(`Here: ${here.toString()}\nColombo: ${c_date.toString()}`);
// $('#c_date').text(c_date);
}


	function prevBtn(){
		// var app_date = '<%=app_date%>';
		var app_date = $('#c_date').text();
		var app_number = $('#ongoing_number').text();
		console.log(app_date); console.log(app_number);
		if(app_number != 0 && app_number != 1){
			var new_number = parseInt(app_number) - 1;
		}

		var bodydata = {
			"appointment_number":new_number,
    		"date":app_date
        	};

		$.ajax({        
        	url: 'http://nenotechnologies-001-site13.etempurl.com/api/appointment/setNextNumber',
        	type: 'POST',
			headers: {
        	    AccessToken: '<%= accessToken %>'
        	},
        	data : bodydata,
			json: true,
        	success: function(res) {
				// console.log(res);
				if(res.Status == 'Success'){
						$('#ongoing_number').text(new_number);				
				}
			}
		});
	}

	function nextBtn(){
		var app_date = '<%=app_date%>';
		var app_number = $('#ongoing_number').text();
		// console.log(app_date); console.log(app_number);

		if(app_number != 30){
			var new_number = parseInt(app_number) + 1;
		}
		var bodydata = {
			"appointment_number":new_number,
    		"date":app_date
        	};

		$.ajax({        
        	url: 'http://nenotechnologies-001-site13.etempurl.com/api/appointment/setNextNumber',
        	type: 'POST',
			headers: {
        	    AccessToken: '<%= accessToken %>'
        	},
        	data : bodydata,
			json: true,
        	success: function(res) {
				// console.log(res);
				if(res.Status == 'Success'){					
					$('#ongoing_number').text(new_number.toFixed(0));										
				}
			}
		});
	}

	function currentnumBtn(){
		var app_date = '<%=app_date%>';

		$.ajax({        
        	url: 'http://nenotechnologies-001-site13.etempurl.com/api/appointment/getcurrentNumber?date='+app_date,
        	type: 'GET',
			json: true,
        	success: function(res) {
				console.log(res.data.current_number);
				if(res.data.current_number == 0){
					console.log('in');
					$('#ongoing_number').text("hello");
				}
				$('#ongoing_number').text(res.data.current_number);
			}
		});
	}

	function clicknumBtn(){
		var app_date = '<%=app_date%>';
		var app_number = $('#ongoing_number').text();

		var bodydata = {
			"appointment_number":app_number,
    		"date":app_date
        	};

		$.ajax({        
        	url: 'http://nenotechnologies-001-site13.etempurl.com/api/appointment/setNextNumber',
        	type: 'POST',
			headers: {
        	    AccessToken: '<%= accessToken %>'
        	},
        	data : bodydata,
			json: true,
        	success: function(res) {
				if(res.Status == 'Success'){					
					$('#ongoing_number').text(app_number);										
				}
			}
		});
	}
</script>

</html>